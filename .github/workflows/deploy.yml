name: Deploy Static website using S3

on:
  workflow_dispatch:
    inputs:
      bucket_name:
        description: 'S3 Bucket name'
        required: true
        default: 'iec-mon'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Create S3 bucket
      run: |
        if ! aws s3api head-bucket --bucket ${{ github.event.inputs.bucket_name }} 2>/dev/null; then
          aws s3api create-bucket --bucket ${{ github.event.inputs.bucket_name }} --region us-east-1
          echo "Bucket created successfully"
        else
          echo "Bucket already exists"
        fi

    - name: Enable public access
      run: |
        aws s3api put-public-access-block \
          --bucket ${{ github.event.inputs.bucket_name }} \
          --public-access-block-configuration \
          '{"BlockPublicAcls":false,"IgnorePublicAcls":false,"BlockPublicPolicy":false,"RestrictPublicBuckets":false}' || {
          echo "Failed to configure public access block"
          exit 1
        }

    - name: Set public read policy
      run: |
        cat > bucket-policy.json <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::\${{ github.event.inputs.bucket_name }}/*"
            }
          ]
        }
        EOF
        if ! aws s3api put-bucket-policy --bucket ${{ github.event.inputs.bucket_name }} --policy file://bucket-policy.json; then
          echo "Failed to apply bucket policy"
          rm -f bucket-policy.json
          exit 1
        fi
        rm -f bucket-policy.json

    - name: Upload static site files
      run: |
        if ! aws s3 cp index.html s3://${{ github.event.inputs.bucket_name }}/; then
          echo "Failed to upload index.html"
          exit 1
        fi
        if ! aws s3 cp icon.png s3://${{ github.event.inputs.bucket_name }}/; then
          echo "Failed to upload icon.png"
          exit 1
        fi
        echo "All files uploaded successfully"
